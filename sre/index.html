<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="refresh" content="3600">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/>
    <link href="assets/style.css" rel="stylesheet" type="text/css"/>

    <script src="lib/jquery-2.0.3.min.js"></script>
    <script src="lib/signals-1.0.0.min.js"></script>
    <script src="lib/hasher-1.2.0.min.js"></script>
    <script src="lib/crossroads-0.12.0.min.js"></script>

    <script src="config.js"></script>
    <script src="dashboard.js"></script>
    <script src="assets/main.js"></script>

    <script>
        $(function() {
            var interval = '2h';
            var errorLimit = 15;

            function playSound() {
                var audio = new Audio('assets/ding.wav');
                audio.play();
            }

            function updateGraphs() {
                var additionalParams = [
                    'hideLegend=' + $('#toggle-legend').is(':checked')
                ];

                if ($('#toggle-darkmode').is(':checked')) {
                    additionalParams.push('fgcolor=ffffff&bgcolor=000000');
                }

                redrawGraphs(interval, additionalParams);
            }

            $('#toggle-legend').click(function() {
                updateGraphs();
                window.localStorage.setItem('legend', $(this).is(':checked') ? 'off' : 'on');
            });

            $('#toggle-darkmode').click(function() {
                updateGraphs();
                $('body').toggleClass('dark');
                window.localStorage.setItem('darkmode', $(this).is(':checked') ? 'on' : 'off');
            });

            if (window.localStorage.getItem('legend') == 'off') {
                $('#toggle-legend').prop('checked', true);
            }

            if (window.localStorage.getItem('darkmode') == 'on') {
                $('#toggle-darkmode').prop('checked', true);
                $('body').toggleClass('dark');
            }

            crossroads.addRoute('/from/{period}', function(period) {
                interval = period;
                updateGraphs();
            });

            function handleChanges(newHash, oldHash) {
                crossroads.parse(newHash ? newHash : '/from/' + interval);
            }

            hasher.changed.add(handleChanges);
            hasher.initialized.add(handleChanges);
            hasher.init();

            setCounters({
                RPS: function(value) {
                    $('#rps-count span').text(value.toFixed(0));
                },
                errors: function(value) {
                    $('#5xx-count span').text(value.toFixed(1));
                    $('#5xx-count').toggleClass('alert', value >= errorLimit);
                    if (value >= errorLimit) {
                        playSound();
                    }
                }
            });

            setInterval(function() {
                updateGraphs();
            }, config.updateInterval);
        });
    </script>
</head>
<body>
    <nav>
        <a href="#/from/30min">30 min</a>
        <a href="#/from/2h">2 hours</a>
        <a href="#/from/6h">6 hours</a>
        <a href="#/from/12h">12 hours</a>
        <a href="#/from/1d">1 day</a>
        <a href="#/from/7d">1 week</a>
        <label for="toggle-legend"><input type="checkbox" id="toggle-legend" checked="checked"/>No legend</label>
        <label for="toggle-darkmode"><input type="checkbox" id="toggle-darkmode"/>Night mode</label>
    </nav>
    <section class="dashboard" id="dashboard">
        <ul class="main-graphs">
            <!--<li data-template="timings_by_host(frontik[0-9]*)">Response time by host</li>-->
            <!--<li data-template="rps_by_host(frontik[0-9]*)">RPS by host</li>-->
            <li data-template="semaphore(frontik[0-9]*, total)">Frontik RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, total)">Frontik stages q95</li>
            <li data-template="semaphore(api[0-9]*, total)">API RPS</li>
            <li data-template="semaphore(logic[0-9]*, total)">Logic RPS</li>
            <li data-template="stages-logic-q95(logic[0-9]*, total)">Logic stages q95</li>
        </ul>
        <ul class="all-graphs">
            <li id="rps-count" class="graph-counter">RPS: <span>NA</span></li>
            <li id="5xx-count" class="graph-counter">5xxPS: <span>NA</span></li>
            <li data-template="semaphore(frontik[0-9]*, page.xhh_pages_index)">Index RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, page.xhh_pages_index)">Index stages q95</li>
            <li data-template="semaphore(frontik[0-9]*, page.xhh_pages_applicant_searchvacancyresult)">Vacancy search RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, page.xhh_pages_applicant_searchvacancyresult)">Vacancy search stages q95</li>
            <li data-template="semaphore(frontik[0-9]*, page.xhh_pages_vacancy)">Vacancy RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, page.xhh_pages_vacancy)">Vacancy stages q95</li>
            <li data-template="semaphore(frontik[0-9]*, page.xhh_pages_employerview)">Employer RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, page.xhh_pages_employerview)">Employer stages q95</li>
            <li data-template="semaphore(frontik[0-9]*, page.xhh_pages_applicant_negotiations)">Applicant negotiations RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, page.xhh_pages_applicant_negotiations)">Applicant negotiations stages q95</li>
            <li data-template="semaphore(frontik[0-9]*, page.xhh_pages_resume)">Resume RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, page.xhh_pages_resume)">Resume stages q95</li>
            <li data-template="semaphore(frontik[0-9]*, page.xhh_pages_employer_vacancies)">Employer vacancies RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, page.xhh_pages_employer_vacancies)">Employer vacancies stages q95</li>
            <li data-template="semaphore(frontik[0-9]*, page.xhh_pages_employer_vacancyresponses)">Employer negotiations RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, page.xhh_pages_employer_vacancyresponses)">Employer negotiations stages q95</li>
            <li data-template="semaphore(frontik[0-9]*, page.xhh_pages_resumesearch_result)">Resume search RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, page.xhh_pages_resumesearch_result)">Resume search stages q95</li>
            <li data-template="semaphore(frontik[0-9]*, page.xhh_pages_applicant_resumes)">Applicant resumes RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, page.xhh_pages_applicant_resumes)">Applicant resumes stages q95</li>
            <li data-template="semaphore(frontik[0-9]*, page.xhh_pages_related_resumes)">Related resumes RPS</li>
            <li data-template="stages-frontik-q95(frontik[0-9]*, page.xhh_pages_related_resumes)">Related resumes stages q95</li>
        </ul>
    </section>
</body>
</html>
